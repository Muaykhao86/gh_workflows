name: "Terraform PR Checks"

on:
  pull_request:
    branches:
      - main

env:
  TERRAFORM_DIR: "automation/terraform/"
  LAMBDA_DIR: "automation/aws_lambda/"
  CCOE_DIR: "automation/terraform/"
  # CCOE_MODULES_DIR: "automation/terraform/ccoe/modules/"

jobs:
  # Need to expose the env vars so we can pass it to the reusable workflow
  vars:
    name: "Compute Variables"
    runs-on: ubuntu-latest
    outputs:
      terraform_dir: ${{ env.TERRAFORM_DIR }}
      lambda_dir: ${{ env.LAMBDA_DIR }}
      ccoe_dir: ${{ env.CCOE_DIR }}
      ccoe_modules_dir: ${{ env.CCOE_MODULES_DIR }}
    steps:
      - run: echo "Exposing env vars"

  check_dirs_changes:
    uses: ./.github/workflows/check_directory_diff.yaml
    needs: vars
    with: 
      dirs: "${{ needs.vars.outputs.terraform_dir }},${{ needs.vars.outputs.lambda_dir }}"

  terraform_pr_checks:
    name: "Terraform PR Checks"
    runs-on: ubuntu-latest
    needs: [check_dirs_changes, vars]
    if: ${{ contains(needs.check_dirs_changes.outputs.directories_changed, needs.vars.outputs.terraform_dir) }}
    steps:
      - name: test
        run: |
          echo ${{ needs.check_dirs_changes.outputs.directories_changed }}
          echo ${{ needs.vars.outputs.terraform_dir }}
          echo ${{ contains(needs.check_dirs_changes.outputs.directories_changed, needs.vars.outputs.terraform_dir) }}
          echo "Terraform changes detected"
      # - name: Checkout
      #   uses: actions/checkout@v4

      # - name: Setup Terraform
      #   uses: hashicorp/setup-terraform@v3

      # - name: Run Terraform Format Check
      #   id: FMT
      #   working-directory: ${{ env.TERRAFORM_DIR }}
      #   run: terraform fmt -recursive -check
        
      # - name: Run Terraform Init
      #   working-directory: ${{ env.CCOE_DIR }}
      #   run: terraform init -backend=false
      
      # - name: Run Terraform Validation Check
      #   id: Validate
      #   working-directory: ${{ env.CCOE_DIR }}
      #   run: terraform validate

      # - name: Detect Specific Module Changes
      #   id: Filter
      #   run: |
      #     # Initialize variables
      #     modules_base="${{ needs.vars.outputs.ccoe_modules_dir }}"
      #     filter_paths=""
          
      #     # Modules to check for changes
      #       modules=(
      #       "auto_scaling_group"
      #       "baseline"
      #       "compute"
      #       "container"
      #       "databases"
      #       "networking"
      #       "storage"
      #       "databases"
      #       "load_balancers"
      #       "machine_learning"
      #       "machine_learning"
      #       "network"
      #       "security"
      #       "serverless_functions",
      #       "storage"
      #       )
          
      #     # Check if any module has changed
      #     for module in "${modules[@]}"; do
      #       module_path="${modules_base}${module}"

            
      #       for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
      #       if [[ $file == ${module_path}/* ]]; then
      #           if [[ -n "$filter_paths=""" ]]; then
      #             filter_paths+=","
      #           fi
         
      #           filter_paths+="$module_path"
      #           break
      #       fi
            
      #       # Append to filtered modules if changed
      #       if [[ $module_changed == true ]]; then
              
      #       fi
      #     done
          
      #     # Output the JSON object of changed modules
      #     changed_modules=$(cat module_changes.txt | sed 's/module_changes=//')
      #     echo "changed_modules=${changed_modules}" >> $GITHUB_OUTPUT
      #     echo "any_changed=${any_changed}" >> $GITHUB_OUTPUT

      # - name: Run Terraform Test
      #   id: Test
      #   if: ${{ steps.Filter.outputs.any_changed == 'true' }}
      #   working-directory: ${{ env.CCOE_DIR }}
      #   run: |
      #     # Initialize variables
      #     changed_modules="${{ steps.Filter.outputs.changed_modules }}"
          
      #     # Run tests for each module
      #     for module in $changed_modules; do
      #       terraform test -module-path=$module
      #     done
    
  # ! If terraform changes run tf tests
  lambda_pr_checks:
    name: "Lambda PR Checks"
    runs-on: ubuntu-latest
    needs: [check_dirs_changes, vars]
    if: ${{ contains(needs.check_dirs_changes.outputs.directories_changed, needs.vars.outputs.lambda_dir) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Identify changed lambda directories
        id: lambda_changes
        run: |
          # Get all changed files
          CHANGED_FILES="${{ needs.check_dirs_changes.outputs.all_changed_files }}"
          LAMBDA_BASE_DIR="${{ needs.vars.outputs.lambda_dir }}"
          echo "Analyzing changed files for Lambda functions..."
          echo "List of files -> $CHANGED_FILES"
          
          # Create an array to store lambda directories
          old_IFS=$IFS
          IFS=','
          echo "$IFS"
          LAMBDA_DIRS=()
          # Extract lambda function directories
          for file in ${CHANGED_FILES[@]}; do
            echo "Checking $file"
            # Is the file in the base lambda dir?
            if [[ $file == $LAMBDA_BASE_DIR* ]]; then
              echo "File: $file"

              # Extract the lambda function directory (assumes structure like automation/aws_lambda/function-name/*)
              lambda_dir=$(echo "$file" | awk -F/ '{print $1"/"$2"/"$3}')
              echo $lambda_dir
              # Check if we already added this directory to the list
              if [[ ! " ${LAMBDA_DIRS[*]} " =~ " ${lambda_dir} " ]]; then
                LAMBDA_DIRS+=("$lambda_dir")
                echo "Found changes in Lambda function: $lambda_dir"
              fi
            fi
          done
          
          # Expose the list of directories for later steps
          echo "lambda_dirs=${LAMBDA_DIRS[*]}" >> $GITHUB_OUTPUT
          echo "${LAMBDA_DIRS[*]}"
          echo "count=${#LAMBDA_DIRS[@]}" >> $GITHUB_OUTPUT
          echo "Number of DIRs Changed: ${#LAMBDA_DIRS[@]}"
      
      - name: Process Lambda functions and test
        if: ${{ steps.lambda_changes.outputs.count > 0 }}
        env:
          lambda_dirs: ${{ steps.lambda_changes.outputs.lambda_dirs }}
          lambda_dir_count: ${{ steps.lambda_changes.outputs.count }}
        run: |
          echo "Processing ${lambda_dir_count} Lambda functions"
          
          for lambda_dir in ${lambda_dirs}; do
            echo "Checking runtime for $lambda_dir"
            
            # if it has a package.json its node
            if [ -f "$lambda_dir/package.json" ]; then
              echo "Node.js Lambda detected in $lambda_dir"
              echo "RUNTIME=node" >> $GITHUB_ENV
              
              # Run Node.js specific tests
              cd $lambda_dir
              npm ci
              echo "RUNNING NODE TESTS!!"
              # npm test
              cd -
              
            # if it as a requirements.txt its python, all dirs will have one or the other if there are tests
            elif [ -f "$lambda_dir/requirements.txt" ]; then
              echo "Python Lambda detected in $lambda_dir"
              echo "LAMBDA_DIR=$lambda_dir" >> $GITHUB_ENV
              echo "RUNTIME=python" >> $GITHUB_ENV
              
              # Run Python specific tests
              cd $lambda_dir
              pip install -r requirements.txt -t ./package
              echo "RUNNING PYTHON TESTS!!"
              pytest tests/รท
              cd -
              
            else
              echo "No tests to run from $lambda_dir"
            fi
          done

      # - name: Set up Node.js
      #   if: env.runtime == 'node'
      #   uses: actions/setup-node@v4
      #   with:
      #     node-version: '20'

      # - name: Set up Python
      #   if: env.runtime == 'python'
      #   uses: actions/setup-python@v4
      #   with:
      #     python-version: '3.12'

      # - name: Install dependencies and package Node Lambda 
      #   if: env.runtime == 'node'
      #   run: |
      #     cd ${{ inputs.lambda_dir }}
      #     npm ci --omit=dev
      #     zip -r ./lambda.zip .
          
      # - name: Install dependencies and package Python Lambda
      #   if: env.runtime == 'python'
      #   run: |
      #     cd ${{ inputs.lambda_dir }}
      #     mkdir -p package
      #     cp *.py package/
      #     if [ -f "requirements.txt" ]; then
      #       pip install -r requirements.txt -t package/
      #     fi
      #     cd package
      #     zip -r ../lambda.zip .

      # - name: Run python tests
      #   env:
      #     PYTHONPATH: ./  # Set the PYTHONPATH for the tests
      #   run: |
      #     pytest tests/unit/test_handler.py

      # - name: Run NPM tests
      #   run: |
      #     npm run test
